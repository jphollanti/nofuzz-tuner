<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Detector</title>
</head>
<body>
    <h1>Pitch Detection with WASM</h1>
    <button id="start">Start Recording</button>
    <button id="stop">Stop Recording</button>
    <div id="pitch"></div>

    <script type="module">
        
        import init, { YinPitchDetector } from './nofuzz_tuner_lib/pkg/nofuzz_tuner_lib.js';

        let audioContext;
        let scriptProcessor;
        let input;
        let pitchOutputElement = document.getElementById('pitch');

        function find_string_and_distance(pitch) {
            const strings = [
                { name: 'E2', frequency: 82.41 },
                { name: 'A2', frequency: 110.00 },
                { name: 'D3', frequency: 146.83 },
                { name: 'G3', frequency: 196.00 },
                { name: 'B3', frequency: 246.94 },
                { name: 'E4', frequency: 329.63 }
            ];

            let minDistance = Infinity;
            let string = null;
            let frequency = null;

            for (const s of strings) {
                const distance = Math.abs(pitch - s.frequency);
                if (distance < minDistance) {
                    minDistance = distance;
                    string = s.name;
                    frequency = s.frequency;
                }
            }

            return { frequency, distance: minDistance, string };
        }

        async function run() {
            await init();

            const detector = new YinPitchDetector(0.1, 60.0, 500.0, 44100);

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
            input = audioContext.createMediaStreamSource(stream);
            input.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);

            scriptProcessor.onaudioprocess = function(event) {
                const inputBuffer = event.inputBuffer.getChannelData(0);
                const audioData = new Float64Array(inputBuffer);
                const pitch = detector.maybe_find_pitch_js(audioData);
                if (pitch) {
                    const sd = find_string_and_distance(pitch);
                    let corr = "";
                    if (Math.abs(sd.distance) > .9) {
                        const dir = sd.distance < 0.0 ? ">" : "<";
                        corr = `, correction: ${dir} ${sd.distance.toFixed(2)}`;
                    }
                    pitchOutputElement.innerText = `Pitch: ${pitch} Hz, Tuning to string: ${sd.string}${corr}`;
                }
            };
        }
        document.getElementById('start').onclick = async function() {
            await run();
        };

        document.getElementById('stop').onclick = function() {
            scriptProcessor.disconnect();
            input.disconnect();
            audioContext.close();
        };
    </script>

</body>
</html>